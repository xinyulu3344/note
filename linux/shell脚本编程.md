# shell脚本编程

## bash

```bash
-n 检查语法，只读取不执行
-x 进入跟踪方式，显示所执行的每一条命令
-c 从字符串中读取命令
```

## 三种错误

- 语法错误，会导致后续的命令不继续执行，可以通过`bash -n`检查出来
- 命令错误，后续的命令还会继续执行，用`bash -n`无法检查出来，但是可以通过`bash -x`观察
- 逻辑错误

## 变量

### 变量类型

- 内置变量，如：PS1，PATH，HISTSIZE，UID，HOSTNAME，PPID，BASHPID 
- 用户自定义变量

### 常见内置变量

| 变量名  | 解释                     | 默认值 |
| ------- | ------------------------ | ------ |
| SHLVL   | bash的嵌套层数           |        |
| PATH    |                          |        |
| USER    |                          |        |
|         |                          |        |
|         |                          |        |
|         |                          |        |
|         |                          |        |
|         |                          |        |
|         |                          |        |
|         |                          |        |
| _       | 前一个命令的最后一个参数 |        |
| LANG    |                          |        |
| BASHPID |                          |        |
| PPID    |                          |        |



### Shell中变量命名法则

- 不能使用保留字：if、for、then、else
- 只能使用数字、字母和下划线，不能以数字开头
- 见名知义，用英文单词命名，并体现实际作用，不要用简写
- 统一命名规则：驼峰命名法
- 变量名大写
- 局部变量小写
- 函数名小写

### 变量定义和引用

变量的生效范围等标准划分变量类型

- 普通变量：生效范围为当前shell进程；对当前shell之外的其它shell进程，包括当前shell的子shell进程均无效
- 环境变量：生效范围为当前shell进程及其子shell进程
- 本地变量：生效范围为当前shell进程中某代码片段，通常指函数

**变量赋值：**

```bash
name='value'
name=123
name="$USER"
name=`COMMAND` 或 name=$(COMMAND)
```

变量赋值是临时生效的，当退出终端后，变量会自动删除。脚本中的变量会在脚本退出后删除。

**变量引用：**

```bash
$name
${name}
```

弱引用和强引用

- "$name" 弱引用，其中的变量引用会被替换为变量值
- '$name' 强引用，其中的变脸引用不会被替换为变量值，而是保持原样

> 注意，当变量值为多行的时候，引用变量是否加双引号有区别。加双引号，多行输出，不加单行输出。如：

```bash
]# NUMS=`seq 3`
]# 
]# echo "$NUMS"
1
2
3
]# 
]# echo $NUMS
1 2 3
```

**利用变量实现动态命令**

```bash
]# CMD=hostname
]# $CMD
CentOS74
```



### 删除变量

```bash
unset 变量名1 变量名2
unset name1 name2
```

### 环境变量

环境变量：

- 可以使子进程（包括孙子进程）继承父进程的变量，但是无法让父进程使用子进程的变量。
- 一旦子进程修改从父进程继承的变量，将会把新的值传递给孙子进程
- 一般只在系统配置文件中使用，脚本中使用较少

**环境变量声明和赋值：**

```bash
# 声明并赋值
export name=value
declare -x name=value

# 赋值再声明
name=value
export name
```

**变量引用：**

```bash
$name
${name}
```

> 注意：花括号可以用在多个变量连起来写时，分割的作用

```bash
]# NAME=zhangsan
]# AGE=10
]# echo $NAME$AGE
zhangsan10
]# 
]# echo $NAME-$AGE
zhangsan-10
]# 
]# echo $NAME_$AGE
10
]# 
]# echo ${NAME}_$AGE
zhangsan_10
```

**显示所有环境变量**

```bash
env
printenv
export
declare -x
```

### 只读变量

只能声明定义，但后续不能修改和删除

**声明只读变量：**

```bash
readonly PI=3.1415926
declare -r PI=3.1415926
```

**查看只读变量**

```bash
readonly [-p]
declare -r
```

### 位置变量

在bash shell中内置的变量，在脚本代码中，通过命令行传递给脚本的参数

| 位置变量      | 解释                                         |      |
| ------------- | -------------------------------------------- | ---- |
| `$1, $2, ...` | 对应第1个，第2个等参数                       |      |
| `$0`          | 命令本身，包括路径                           |      |
| `$*`          | 传递给脚本的所有参数，全部参数合为一个字符串 |      |
| `$@`          | 传递给脚本的所有参数，每个参数为独立字符串   |      |
| `$#`          | 传递给脚本的参数的个数                       |      |

> 注意：`$@和$*`只在被双引号包起来的时候才会有差异

**清空所有位置变量**

```bash
set --
```

### 退出状态码变量

进程执行后，将使用`$?`来保存状态码的相关数字。取值范围0-255

```bash
0     代表成功
1-255 代表失败
```

通过exit命令自定义退出状态码

```bash
exit 0
```

> 注意：
>
> - 脚本中一旦遇到exit命令，脚本会立即终止。
> - 如果未使用exit命令指定退出码，最终退出码由脚本执行的最后一个命令的状态码决定

### 展开命令行

**展开命令执行顺序**

```bash
把命令行分成单个命令词
展开别名
展开花括号声明{}
展开~声明
命令替换$()和``
再次把命令行分成命令词
展开文件通配符*、?、[abc]等
准备I/O重定向<, >
运行命令
```

### 脚本安全和set

**$-变量**

```bash
]# echo $-
himBH
```

| 字母 | 解释                                                         |      |
| ---- | ------------------------------------------------------------ | ---- |
| h    | hashall，打开选项后，Shell会将命令所在的路径hash下来，避免每次都要查询。通过`set +h`将h选项关闭 |      |
| i    | interactive-comments。包含这个选项，说明当前的shell是一个交互式的shell。在脚本中，i选项是关闭的 |      |
| m    | monitor，打开监控模式，就可以通过job control来控制进程的停止、继续、后台或者前台执行 |      |
| B    | braceexpand，大括号扩展                                      |      |
| H    | history，H选项打开，可以展开历史列表中的命令，可以通过`!`感叹号来完成，例如`!!`返回最近的一个历史命令，`!n`返回第n个历史命令 |      |

**set命令实现脚本安全**

```bash
-u 
-e
-o
-x
```

